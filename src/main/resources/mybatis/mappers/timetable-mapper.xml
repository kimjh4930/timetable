<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="timetable">

	<resultMap id="lineEvaluationModelResult" type="lineEvaluationModel">
		<result column="code" property="subjectCode"/>
		<result column="title" property="subjectName"/>
		<result column="professor" property="professorName"/>
		<result column="avgStarScore" property="avgStarScore"/>
		<collection column="code" property="itemList" select="selectLineEvaluationItem"/>
	</resultMap>
	
	<resultMap id="lineEvaluationItemResult" type="lineEvaluationItem">
		<result column="le_no" property="indexNo"/>
		<result column="user_id" property="userId"/>
		<result column="comment" property="comment"/>
		<result column="star_score" property="starScore"/>
	</resultMap>

    <select id="selectPersonalData" resultType="personalModel" parameterType="personalCommandModel">
        SELECT idx_no as indexNo, member_srl as memberCode, semester as semester, tt_no as timetableNo,
        subject_list as subjectStr, insertdate as insertDate, updatedate as updateDate
        FROM tt_personal
        WHERE member_srl = #{memberCode} and tt_no = #{timetableNo}
    </select>
    
    <select id="selectLineEvaluation" resultMap="lineEvaluationModelResult" parameterType="String">
    	SELECT
    		code,
    		title,
    		professor,
    		(
    			SELECT AVG(star_score)
    			FROM tt_line_evaulation
    			WHERE subject_code = #{subjectCode}
    		) as avgStarScore
    	FROM 
    		tt_subject
    	WHERE
    		code = #{subjectCode}
    </select>
    
    <select id="selectLineEvaluationItem" resultMap="lineEvaluationItemResult" parameterType="String">
    	SELECT
    		le.le_no,
    		m.user_id,
    		le.comment,
    		le.star_score
    	FROM 
    		tt_line_evaulation le, xe_member m
    	WHERE
    		le.member_srl = m.member_srl
    	AND
    		le.subject_code = #{subjectCode}
    </select>
    
    <select id="selectMember" resultType="int" parameterType="int">
        SELECT count(*)
        FROM xe_member
    </select>
    
    <select id="searchSubject" resultType="subjectResultModel" parameterType="subjectCommandModel">
        SELECT
            code AS subjectCode,
			title AS subjectName,
			section AS subjectDivide,
			major AS subjectDept,
			classyear AS grade,
			credit AS credit,
			professor AS professorName,
			classhour AS classTime,
			classroom AS classroom
        FROM 
            tt_subject
        WHERE
            1 = 1
      <if test="searchType == 'subject'">
        AND title LIKE '%' || #{searchKey} || '%'
      </if>
      <if test="searchType == 'professor'">
        AND professor LIKE '%' || #{searchKey} || '%'
      </if>
    </select>
    <select id="selectDepartment" resultType="String">
        SELECT
            major As subjectDept
        FROM
            tt_subject
        GROUP BY major
    </select>
    <select id="searchSubjectByDepartment" resultType="subjectResultModel" parameterType="subjectCommandModel">
        SELECT
            code AS subjectCode,
            title AS subjectName,
            section AS subjectDivide,
            major AS subjectDept,
            classyear AS grade,
            credit AS credit,
            professor AS professorName,
            classhour AS classTime,
            classroom AS classroom
        FROM 
            tt_subject
        WHERE
            1 = 1
    </select>
    
    
</mapper>